"use client";
import Breadcrumb from './Breadcrumb';

import React, { useState, useEffect, useMemo } from 'react';
import { api } from '../services/api';
import Link from 'next/link';
import UsersTable from './UsersTable';
import { useToast } from '../components/ToastProvider';
import CreateAssessmentModal from './assessments/CreateAssessmentModal';
import { getAssessments, AssessmentSummary, updateAssessment, archiveAssessment, getArchivedAssessments, unarchiveAssessment, BoardColumn, getAssessmentMeta } from '../services/assessments';

interface User {
  id: string;
  email: string;
  name: string;
  role: string;
}

interface AuthenticatedDashboardProps {
  user: User;
  onLogout: () => void;
}

const AuthenticatedDashboard: React.FC<AuthenticatedDashboardProps> = ({ user, onLogout }) => {
  const { showToast } = useToast();
  const [dashboardData, setDashboardData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [assessments, setAssessments] = useState<AssessmentSummary[]>([]);
  const [openCreate, setOpenCreate] = useState(false);
  const [statusFilter, setStatusFilter] = useState<'all'|'backlog'|'inprogress'|'review'|'finished'>('all');
  const [query, setQuery] = useState('');
  const filteredAssessments = useMemo(() =>
    assessments.filter(a =>
      (statusFilter === 'all' || a.col === statusFilter) &&
      (query.trim() === '' ||
        a.title.toLowerCase().includes(query.toLowerCase()) ||
        a.id.toLowerCase().includes(query.toLowerCase()))
    ),
    [assessments, statusFilter, query]
  );

  const [archivedAssessments, setArchivedAssessments] = useState<AssessmentSummary[]>([]);
  const [showArchived, setShowArchived] = useState(false);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState('');
  const [editCol, setEditCol] = useState<BoardColumn>('backlog');
  const [editDueIn, setEditDueIn] = useState('');
  const [selectedRecent, setSelectedRecent] = useState<Record<string, boolean>>({});
  const selectedRecentIds = useMemo(()=> (filteredAssessments||[]).slice(0,6).filter(a=> selectedRecent[a.id]).map(a=> a.id), [filteredAssessments, selectedRecent]);
  const [selectedArchived, setSelectedArchived] = useState<Record<string, boolean>>({});
  const selectedArchivedIds = useMemo(()=> (archivedAssessments||[]).filter(a=> selectedArchived[a.id]).map(a=> a.id), [archivedAssessments, selectedArchived]);

  // Aggregated meta for Files/Attachments and Messages counters
  const [attachmentsCount, setAttachmentsCount] = useState<number | null>(null);
  const [messagesCount, setMessagesCount] = useState<number | null>(null);
  const [avgProgress, setAvgProgress] = useState<number>(0);

  // Utilities
  const relTime = (ts?: string) => {
    try {
      if (!ts) return "";
      const t = new Date(ts).getTime();
      if (isNaN(t)) return ts;
      const diff = Math.max(0, Date.now() - t);
      const m = Math.floor(diff/60000);
      if (m < 1) return "just now";
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h}h ago`;
      const d = Math.floor(h/24);
      if (d < 7) return `${d}d ago`;
      const w = Math.floor(d/7);
      return `${w}w ago`;
    } catch { return ts || ""; }
  };

  const initials = (name?: string) =>
    (name || '?')
      .split(' ')
      .filter(Boolean)
      .slice(0, 2)
      .map(s => s[0]?.toUpperCase())
      .join('');


  useEffect(() => {
    let alive = true;
    (async () => {
      setLoading(true);
      setError(null);
      try {
        const [dashResp, asses] = await Promise.all([
          api.getDashboardData(),
          getAssessments(),
        ]);
        if (!alive) return;
        if (!dashResp.success || !dashResp.data) {
          throw new Error(dashResp.message || 'Failed to load dashboard');
        }
        setDashboardData(dashResp.data);
        setAssessments(asses);
      } catch (e: any) {
        const msg = e?.message || 'Failed to load dashboard';
        setError(msg);
      } finally {
        if (alive) setLoading(false)
      }
    })()
    return () => { alive = false }
  }, []);

  // Aggregate attachments/messages and compute average progress across a subset of assessments
  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        if (!assessments.length) { setAttachmentsCount(0); setMessagesCount(0); setAvgProgress(0); return; }
        const slice = assessments.slice(0, Math.min(20, assessments.length));
        const metas = await Promise.all(slice.map(a => getAssessmentMeta(a.id).catch(() => ({ attachments: 0, messages: 0, progress: 0 }))));
        if (!alive) return;
        const att = metas.reduce((acc, m) => acc + (m.attachments || 0), 0);
        const msg = metas.reduce((acc, m) => acc + (m.messages || 0), 0);
        setAttachmentsCount(att);
        const prog = metas.length ? Math.round(metas.reduce((acc, m) => acc + (m.progress || 0), 0) / metas.length) : 0;
        setAttachmentsCount(att);
        setMessagesCount(msg);
        setAvgProgress(prog);
      } catch {
        if (alive) { setAttachmentsCount(0); setMessagesCount(0); setAvgProgress(0); }
      }
    })();
    return () => { alive = false };
  }, [assessments]);

  if (loading) {
    return (
      <div className="min-h-screen bg-background">
        <header className="bg-background border-b h-[88px]"></header>
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            {Array.from({length:4}).map((_,i)=> (
              <div key={i} className="bg-card rounded-lg p-6 border animate-pulse">
                <div className="h-6 bg-muted rounded w-1/3"></div>
                <div className="h-8 bg-muted rounded w-1/2 mt-3"></div>
              </div>
            ))}
          </div>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="bg-card rounded-lg p-6 border animate-pulse h-64"></div>
            <div className="bg-card rounded-lg p-6 border animate-pulse h-64"></div>
          </div>
        </main>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-background grid place-items-center">
        <div className="text-center text-destructive">{error}</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-background">
      {/* Header */}
      <header className="bg-background border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="py-4">
            <Breadcrumb items={[{ label: 'Home', href: '/' }, { label: 'Dashboard' }]} />
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Stats Grid (beautified) */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          {/* Total Controls */}
          <div className="bg-card rounded-lg p-6 border">
            <div className="flex items-center gap-4">
              <div className="h-10 w-10 rounded-lg bg-primary/10 grid place-items-center border border-primary/20">
                {/* shield icon */}
                <svg className="h-5 w-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              </div>
              <div>
                <p className="text-sm font-medium text-muted-foreground">Total Controls</p>
                <p className="text-2xl font-semibold text-card-foreground">{dashboardData.stats.totalControls}</p>
              </div>
            </div>
          </div>

          {/* Completed */}
          <div className="bg-card rounded-lg p-6 border">
            <div className="flex items-center gap-4">
              <div className="h-10 w-10 rounded-lg bg-green-500/10 grid place-items-center border border-green-500/20">
                {/* check icon */}
                <svg className="h-5 w-5 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5"/></svg>
              </div>
              <div>
                <p className="text-sm font-medium text-muted-foreground">Completed</p>
                <p className="text-2xl font-semibold text-card-foreground">{dashboardData.stats.completedControls}</p>
              </div>
            </div>
          </div>

          {/* Pending Evidence */}
          <div className="bg-card rounded-lg p-6 border">
            <div className="flex items-center gap-4">
              <div className="h-10 w-10 rounded-lg bg-yellow-500/10 grid place-items-center border border-yellow-500/20">
                {/* alert icon */}
                <svg className="h-5 w-5 text-yellow-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              </div>
              <div>
                <p className="text-sm font-medium text-muted-foreground">Pending Evidence</p>
                <p className="text-2xl font-semibold text-card-foreground">{dashboardData.stats.pendingEvidences}</p>
              </div>
            </div>
          </div>

          {/* Upcoming Audits */}
          <div className="bg-card rounded-lg p-6 border">
            <div className="flex items-center gap-4">
              <div className="h-10 w-10 rounded-lg bg-purple-500/10 grid place-items-center border border-purple-500/20">
                {/* calendar icon */}
                <svg className="h-5 w-5 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              </div>
              <div>
                <p className="text-sm font-medium text-muted-foreground">Upcoming Audits</p>
                <p className="text-2xl font-semibold text-card-foreground">{dashboardData.stats.upcomingAudits}</p>
              </div>
            </div>
          </div>
        </div>

        {/* Content Grid A: Activity (2) + Profile (1) */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Recent Activity - timeline style */}
          <div className="bg-card rounded-lg border lg:col-span-2 overflow-hidden">
            <div className="p-4 border-b flex items-center justify-between">
              <h3 className="text-lg font-semibold text-card-foreground">Recent Activity</h3>
              <Link href="#" className="text-sm text-primary hover:brightness-110">View all</Link>
            </div>
            <div className="p-2">
              {(() => {
                const items = (dashboardData.recentActivity || []).slice(0, 8);
                if (!items.length) {
                  return (
                    <div className="p-6 text-sm text-muted-foreground flex items-center gap-2">
                      <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                      </svg>
                      No recent activity
                    </div>
                  );
                }
                return (
                  <ul className="divide-y">
                    {items.map((activity: any) => {
                      const text = activity.description || activity.action || '';
                      const who = activity.user || 'System';
                      const when = relTime(activity.createdAt);
                      const lc = ((activity.action || '') + ' ' + (activity.description || '')).toLowerCase();
                      const tone = lc.includes('delete') || lc.includes('remove')
                        ? 'text-rose-600'
                        : lc.includes('create') || lc.includes('complete') || lc.includes('add')
                        ? 'text-emerald-600'
                        : lc.includes('comment') || lc.includes('note')
                        ? 'text-amber-600'
                        : lc.includes('upload') || lc.includes('file')
                        ? 'text-purple-600'
                        : 'text-blue-600';
                      const borderTone = tone.replace('text-', 'border-');
                      return (
                        <li key={activity.id} className="flex items-start gap-3 p-3 hover:bg-accent/40">
                          <div className="h-8 w-8 rounded-full bg-accent text-accent-foreground grid place-items-center border shrink-0">
                            <span className="text-[11px] font-semibold">{initials(who)}</span>
                          </div>
                          <div className="min-w-0 flex-1">
                            <div className="text-sm text-card-foreground">{text}</div>
                            <div className="mt-0.5 text-xs text-muted-foreground">{who} • {when}</div>
                          </div>
                          <div className={`h-7 w-7 grid place-items-center rounded border bg-card ${borderTone}`}>
                            <svg className={`h-3.5 w-3.5 ${tone}`} viewBox="0 0 24 24" fill="currentColor">
                              <circle cx="12" cy="12" r="6" />
                            </svg>
                          </div>
                        </li>
                      );
                    })}
                  </ul>
                );
              })()}
            </div>
          </div>

          {/* Profile Information */}
          <div className="bg-card rounded-lg border">
            <div className="p-4 border-b">
              <h3 className="text-lg font-semibold text-card-foreground">Profile</h3>
            </div>
            <div className="p-4">
              <div className="flex items-center gap-3 mb-4">
                <div className="h-10 w-10 rounded-full bg-accent text-accent-foreground grid place-items-center border">
                  <span className="text-sm font-semibold">{initials(user.name)}</span>
                </div>
                <div>
                  <div className="text-card-foreground font-medium leading-5">{user.name}</div>
                  <div className="text-xs text-muted-foreground">{user.email}</div>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                <div className="text-muted-foreground">Role</div>
                <div><span className="badge tone-review">{user.role}</span></div>
                <div className="text-muted-foreground">Status</div>
                <div><span className="badge tone-success">Active</span></div>
              </div>
              <div className="mt-4">
                <button onClick={onLogout} className="btn btn-outline w-full">Sign out</button>
              </div>
            </div>
          </div>
        </div>

        {/* Content Grid B: Calendar + Frameworks + Files/Attachments */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
          {/* Calendar Card */}
          <div className="bg-card rounded-lg border">
            <div className="p-4 border-b flex items-center justify-between">
              <h3 className="text-lg font-semibold text-card-foreground">Calendar</h3>
              <Link href="/calendar" className="text-sm text-primary hover:brightness-110">Open</Link>
            </div>
            <div className="p-4">
              {(() => {
                const now = new Date();
                const y = now.getFullYear();
                const m = now.getMonth();
                const start = new Date(y, m, 1);
                const end = new Date(y, m + 1, 0);
                const days = end.getDate();
                const pad = start.getDay(); // 0=Sun
                const cells: (number | null)[] = [];
                      for (let i = 0; i < pad; i++) cells.push(null);
                      for (let d = 1; d <= days; d++) cells.push(d);
                while (cells.length % 7 !== 0) cells.push(null);
                const weeks: (number | null)[][] = [];
                for (let i = 0; i < cells.length; i += 7) weeks.push(cells.slice(i, i + 7));
                const isToday = (d: number | null) => d === now.getDate();
                const dow = ['S','M','T','W','T','F','S'];
                return (
                  <div>
                    <div className="flex items-center justify-between mb-3">
                      <div className="text-sm text-muted-foreground">{now.toLocaleString(undefined, { month: 'long', year: 'numeric' })}</div>
                    </div>
                    <div className="grid grid-cols-7 text-[11px] text-muted-foreground mb-1">
                      {dow.map((d, i) => (<div key={`${d}-${i}`} className="text-center py-1">{d}</div>))}
                    </div>
                    <div className="grid grid-rows-6 gap-1">
                      {weeks.map((w, wi) => (
                        <div key={wi} className="grid grid-cols-7 gap-1">
                          {w.map((d, di) => (
                            <div key={di} className={["h-8 rounded grid place-items-center border",
                              d == null ? 'bg-muted text-muted-foreground' : 'bg-card',
                              d != null && isToday(d) ? 'border-primary text-primary font-semibold' : 'border-border text-card-foreground'
                            ].join(' ')}>
                              {d ?? ''}
                            </div>
                          ))}
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>

          {/* Frameworks Preview (security frameworks) */}
          <div className="bg-card rounded-lg border">
            <div className="p-4 border-b flex items-center justify-between">
              <h3 className="text-lg font-semibold text-card-foreground">Frameworks</h3>
              <Link href="/frameworks" className="text-sm text-primary hover:brightness-110">Open</Link>
            </div>
            <div className="p-4">
              <div className="flex flex-wrap gap-2">
                {['PCI DSS v3.2.1','PCI DSS v4.0','ISO 27001','DORA','SOC 2','HIPAA'].map(fw => (
                  <span key={fw} className="px-2.5 py-1 text-xs rounded-full bg-secondary text-foreground border">{fw}</span>
                ))}
              </div>
              <p className="mt-3 text-xs text-muted-foreground">Compliance frameworks supported.</p>
            </div>
          </div>

          {/* Files/Attachments Numbers */}
          <div className="bg-card rounded-lg border">
            <div className="p-4 border-b">
              <h3 className="text-lg font-semibold text-card-foreground">Files & Attachments</h3>
            </div>
            <div className="p-4 grid grid-cols-2 gap-4">
              <div className="flex items-center gap-3">
                <div className="h-9 w-9 rounded-lg bg-blue-500/10 grid place-items-center border border-blue-500/20">
                  {/* paperclip icon */}
                  <svg className="h-4 w-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 1 1 5.66 5.66l-9.2 9.19a2 2 0 1 1-2.83-2.83l8.49-8.48"/></svg>
                </div>
                <div>
                  <div className="text-xs text-muted-foreground">Attachments</div>
                  <div className="text-xl font-semibold text-card-foreground">{attachmentsCount ?? '—'}</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="h-9 w-9 rounded-lg bg-emerald-500/10 grid place-items-center border border-emerald-500/20">
                  {/* message icon */}
                  <svg className="h-4 w-4 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
                </div>
                <div>
                  <div className="text-xs text-muted-foreground">Messages</div>
                  <div className="text-xl font-semibold text-card-foreground">{messagesCount ?? '—'}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Progress Section (overview of project completion) */}
        <div className="mt-8">
          <div className="bg-card rounded-lg p-6 border">
            <h3 className="text-lg font-semibold text-card-foreground mb-6">Compliance Progress</h3>
            <div className="space-y-6">
              <div>
                <div className="flex justify-between text-sm text-muted-foreground mb-2">
                  <span>Overall completion (avg across projects)</span>
                  <span>{avgProgress}%</span>
                </div>
                <div className="w-full bg-muted rounded-full h-2">
                  <div className="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style={{width: `${avgProgress}%`}}></div>
                </div>
              </div>
              {/* Status distribution summary */}
              {(() => {
                const counts: Record<string, number> = { backlog: 0, inprogress: 0, review: 0, finished: 0 };
                assessments.forEach(a => { counts[a.col] = (counts[a.col] || 0) + 1; });
                const total = assessments.length || 1;
                const pct = (n: number) => Math.round((n / total) * 100);
                const rows = [
                  { label: 'Backlog', k: 'backlog', cls: 'from-gray-400 to-gray-500' },
                  { label: 'In Progress', k: 'inprogress', cls: 'from-blue-500 to-cyan-500' },
                  { label: 'In Review', k: 'review', cls: 'from-yellow-500 to-amber-500' },
                  { label: 'Finished', k: 'finished', cls: 'from-emerald-500 to-green-600' },
                ] as const;
                return (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {rows.map(r => (
                      <div key={r.k}>
                        <div className="flex justify-between text-sm text-muted-foreground mb-1">
                          <span>{r.label}</span>
                          <span>{counts[r.k] || 0} • {pct(counts[r.k] || 0)}%</span>
                        </div>
                        <div className="w-full bg-muted rounded-full h-2">
                          <div className={`h-2 rounded-full bg-gradient-to-r ${r.cls}`} style={{ width: `${pct(counts[r.k] || 0)}%` }} />
                        </div>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
          </div>
        </div>
              
        
        <section className="mt-10">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold text-card-foreground">Assessments Overview</h3>
            <div className="flex items-center gap-3">
              <span className="text-xs text-muted-foreground hidden sm:inline">Summary</span>
              <button onClick={()=>setOpenCreate(true)} className="px-3 py-1.5 bg-primary hover:brightness-110 text-primary-foreground rounded text-sm">+ Create Assessment</button>
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {(() => {
              const counts: Record<string, number> = { backlog: 0, inprogress: 0, review: 0, finished: 0 };
              assessments.forEach(a => { counts[a.col] = (counts[a.col] || 0) + 1; });
              const cards = [
                { key: 'backlog', label: 'Backlog' },
                { key: 'inprogress', label: 'In Progress' },
                { key: 'review', label: 'In Review' },
                { key: 'finished', label: 'Finished' },
              ] as const;
              return cards.map(c => (
                <div key={c.key} className="bg-card rounded-lg p-4 border">
                  <div className="text-sm text-muted-foreground">{c.label}</div>
                  <div className="mt-1 text-2xl font-semibold text-card-foreground">{counts[c.key] || 0}</div>
                </div>
              ));
            })()}
          </div>

          <div className="bg-card rounded-lg border">
            <div className="p-4 border-b flex items-center justify-between">
              <div className="text-card-foreground font-semibold">Recent Assessments</div>
              <Link href="/assessments" className="text-sm text-primary hover:brightness-110">View all</Link>
            </div>
            <div className="px-4 py-3 flex flex-col sm:flex-row sm:items-center gap-3">
              <div className="flex items-center gap-2">
                {(['all', 'backlog', 'inprogress', 'review', 'finished'] as const).map(k => (
                  <button key={k} onClick={()=>setStatusFilter(k)} className={`px-2.5 py-1 rounded text-xs border ${statusFilter===k ? 'bg-accent text-foreground border' : 'text-muted-foreground border hover:brightness-110'}`}>{k}</button>
                ))}
              </div>
              <div className="flex-1" />
              <div className="relative sm:w-64">
                <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Search by title or ID" className="w-full px-3 py-2 rounded bg-card border text-card-foreground placeholder-muted-foreground" />
              </div>
            </div>
            <div className="px-4 text-xs text-muted-foreground">Showing {filteredAssessments.length} of {assessments.length}</div>

            <div className="px-4 py-2 flex items-center gap-2">
              <span className="text-xs text-muted-foreground">Selected: {selectedRecentIds.length}</span>
              <button onClick={()=>{ const next: Record<string, boolean> = {}; filteredAssessments.slice(0,6).forEach(a=> next[a.id]=true); setSelectedRecent(next); }} className="text-xs px-2 py-1 bg-secondary text-foreground rounded border">Select all</button>
              <button onClick={()=> setSelectedRecent({})} className="text-xs px-2 py-1 bg-secondary text-foreground rounded border">Clear</button>
              <button disabled={!selectedRecentIds.length} onClick={async ()=>{ if (!window.confirm('Archive ' + selectedRecentIds.length + ' selected?')) return; let ok=0,fail=0; for (const id of selectedRecentIds){ try { await archiveAssessment(id); ok++; } catch { fail++; } } setAssessments(prev=> prev.filter(x=> selectedRecentIds.indexOf(x.id)===-1)); setSelectedRecent({}); showToast('Archived ' + ok + (fail?(' ('+fail+' failed)'):'') , fail?'error':'success'); }} className="text-xs px-2 py-1 bg-destructive text-destructive-foreground rounded border disabled:opacity-50">Archive selected</button>
            </div>

            <div className="divide-y">
              {filteredAssessments.slice(0,6).map(a => {
                const tone = a.col === "finished" ? "bg-green-500/15 text-green-300 border-green-500/30"
                  : a.col === "review" ? "bg-yellow-500/15 text-yellow-300 border-yellow-500/30"
                  : a.col === "inprogress" ? "bg-blue-500/15 text-blue-300 border-blue-500/30"
                  : "bg-gray-500/15 text-muted-foreground border-gray-500/30";
                return (
                  <div key={a.id} className="flex items-center justify-between px-4 py-3 hover:bg-accent/40">
                    <div className="flex items-center gap-3">
                      <span className={`text-[10px] px-2 py-0.5 rounded-full border ${tone}`}>{a.col}</span>
                      <div>
                        {editingId === a.id ? (
                          <div className="flex items-center gap-2">
                            <input value={editTitle} onChange={(e)=>setEditTitle(e.target.value)} className="px-2 py-1 rounded bg-card border text-card-foreground text-sm" />
                            <select value={editCol} onChange={(e)=>setEditCol(e.target.value as BoardColumn)} className="px-2 py-1 rounded bg-card border text-card-foreground text-sm">
                              <option value="backlog">backlog</option>
                              <option value="inprogress">inprogress</option>
                              <option value="review">review</option>
                              <option value="finished">finished</option>
                            </select>
                            <input value={editDueIn} onChange={(e)=>setEditDueIn(e.target.value)} placeholder="Due in" className="px-2 py-1 rounded bg-card border text-card-foreground text-sm" />
                          </div>
                        ) : (
                          <a href={`/assessments/${a.id}`}>
                            <div className="text-card-foreground">{a.title}</div>
                            <div className="text-xs text-muted-foreground">{a.id}</div>
                          </a>
                        )}
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-xs text-muted-foreground">Due: <span className="text-destructive/80">{editingId === a.id ? editDueIn : a.dueIn}</span></div>
                      {editingId === a.id ? (
                        <>
                          <button className="text-xs px-2 py-1 bg-green-700 text-white rounded border border-green-600" onClick={async ()=>{
                            try {
                            const updated = await updateAssessment(a.id, { title: editTitle, col: editCol, dueIn: editDueIn || a.dueIn });
                            setAssessments(prev => prev.map(x => x.id===a.id ? updated : x));
                            setEditingId(null);
                            showToast('Assessment updated','success');
                          } catch (e: any) { showToast(e?.message || 'Failed to update','error'); }
                          }}>Save</button>
                          <button className="text-xs px-2 py-1 bg-secondary text-foreground rounded border" onClick={()=>setEditingId(null)}>Cancel</button>
                        </>
                      ) : (
                        <>
                          <button className="text-xs px-2 py-1 bg-secondary text-foreground rounded border" onClick={()=>{ setEditingId(a.id); setEditTitle(a.title); setEditCol(a.col as BoardColumn); setEditDueIn(a.dueIn); }}>Edit</button>
                          <button className="text-xs px-2 py-1 bg-destructive text-destructive-foreground rounded border" onClick={async ()=>{
                            if (!window.confirm('Archive this assessment?')) return;
                            try {
                              await archiveAssessment(a.id);
                              setAssessments(prev => prev.filter(x => x.id!==a.id));
                              showToast('Archived','success');
                            } catch (e: any) { showToast(e?.message || 'Failed to archive','error'); }
                          }}>Archive</button>
                        </>
                      )}
                    </div>
                  </div>
                );
              })}
              {assessments.length === 0 && (
                <div className="px-4 py-6 text-sm text-muted-foreground">No assessments found</div>
              )}
            </div>
          </div>
        </section>
        

        

        <section className="mt-10">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold text-card-foreground">Archived Assessments</h3>
            <div className="flex items-center gap-3">
              <label className="text-xs text-muted-foreground">Show</label>
              <input type="checkbox" checked={showArchived} onChange={(e)=>setShowArchived(e.target.checked)} />
            </div>
          </div>
          {showArchived && (

            <div className="bg-card rounded-lg border">
              <div className="px-4 py-2 flex items-center gap-2">
                <span className="text-xs text-muted-foreground">Selected: {selectedArchivedIds.length}</span>
                <button onClick={()=>{ const next: Record<string, boolean> = {}; archivedAssessments.forEach(a=> next[a.id]=true); setSelectedArchived(next); }} className="text-xs px-2 py-1 bg-secondary text-foreground rounded border">Select all</button>
                <button onClick={()=> setSelectedArchived({})} className="text-xs px-2 py-1 bg-secondary text-foreground rounded border">Clear</button>
                <button disabled={!selectedArchivedIds.length} onClick={async ()=>{ if (!window.confirm('Unarchive ' + selectedArchivedIds.length + ' selected?')) return; let ok=0,fail=0; for (const id of selectedArchivedIds){ try { const restored = await unarchiveAssessment(id); setAssessments(prev=> [restored, ...prev]); ok++; } catch { fail++; } } setArchivedAssessments(prev=> prev.filter(x=> selectedArchivedIds.indexOf(x.id)===-1)); setSelectedArchived({}); showToast('Unarchived ' + ok + (fail?(' ('+fail+' failed)'):'') , fail?'error':'success'); }} className="text-xs px-2 py-1 bg-primary text-primary-foreground rounded border disabled:opacity-50">Unarchive selected</button>
              </div>
              <div className="divide-y">
                {archivedAssessments.length === 0 && (
                  <div className="px-4 py-6 text-sm text-muted-foreground">No archived assessments</div>
                )}
                {archivedAssessments.map(a => (
                  <div key={a.id} className="flex items-center justify-between px-4 py-3">
                    <div>
                      <div className="text-card-foreground">{a.title}</div>
                      <div className="text-xs text-muted-foreground">{a.id} • {a.col}</div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-xs text-muted-foreground">Due: <span className="text-destructive/80">{a.dueIn}</span></div>
                      <button className="text-xs px-2 py-1 bg-secondary text-foreground rounded border" onClick={async ()=>{
                        try {
                        const restored = await unarchiveAssessment(a.id);
                        setArchivedAssessments(prev => prev.filter(x => x.id !== a.id));
                        setAssessments(prev => [restored, ...prev]);
                        showToast('Unarchived','success');
                      } catch (e: any) { showToast(e?.message || 'Failed to unarchive','error'); }
                      }}>Unarchive</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </section>

        <section className="mt-10">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold text-card-foreground">User Management</h3>
          </div>
          <div className="space-y-4">
            <UsersTable />
          </div>
        </section>

        <CreateAssessmentModal
          open={openCreate}
          onClose={()=>setOpenCreate(false)}
          onCreate={async ({ title, col, dueIn }) => {
            const created = await (await import('../services/assessments')).createAssessment({ title, col, dueIn });
            setAssessments(prev => [created, ...prev]);
          }}
        />
      </main>
    </div>
  );
};

export default AuthenticatedDashboard;
