const express = require('express');
const cors = require('cors');
const fs = require('fs');
const path = require('path');
const app = express();
const DATA_FILE = path.join(__dirname, 'data.json');
function loadData() {
  try {
    const raw = fs.readFileSync(DATA_FILE, 'utf8');
    return JSON.parse(raw);
  } catch (e) { return null; }
}
function saveData(data) {
  try { fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2)); } catch (e) { console.error('Failed to save data', e); }
}

// In-memory demo users
const users = [
  { id: '1', email: 'admin@acme.example.com', name: 'Admin User', role: 'admin', active: true },
  { id: '2', email: 'manager@acme.example.com', name: 'Manager User', role: 'manager', active: true },
];
const tokenToEmail = new Map();

// In-memory assessments & related data
function isoDaysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d.toISOString(); }
const assessments = [
  { id: 'A-001', title: 'Assessment/ Project Name', col: 'backlog',    dueIn: '1 Days', framework: 'PCI DSS 3.2.1',            created: isoDaysAgo(12) },
  { id: 'A-002', title: 'Assessment/ Project Name', col: 'inprogress', dueIn: '2 Days', framework: 'PCI DSS 4.0',              created: isoDaysAgo(9)  },
  { id: 'A-003', title: 'Assessment/ Project Name', col: 'review',     dueIn: '3 Days', framework: 'ISO/IEC 27001:2013',       created: isoDaysAgo(20) },
  { id: 'A-004', title: 'Assessment/ Project Name', col: 'finished',   dueIn: 'Complete', framework: 'SOC 2 Type II',          created: isoDaysAgo(35) },
];

const tasksByAssessment = {
  'A-001': [
    { id: 'T-1001', name:'Project planning Syncup 1.1', status:'In Progress', due:'3 Days' },
    { id: 'T-1002', name:'Requirement 1.1', status:'Completed', due:'7 Days' },
  ],
  'A-002': [],
  'A-003': [],
  'A-004': [],
};

// Messages (supports threads and tags)
// Message shape: { id, user, time, text, parentId?: string|null, sections?: string[], attachments?: string[] }
const messagesByAssessment = {
  'A-001': [
    { id:'M-1', user:'Lee, Jason', time:'Nov 11, 2020 12:05 PM', text:'When can I expect the final evidences for request 1?', sections:['1.1'] },
    { id:'M-2', user:'Beckham, Victoria', time:'Nov 12, 2020 05:34 PM', text:'We are working with the vendors on this. We should be able to send it by tomorrow.', parentId:'M-1' },
  ]
};

const attachmentsByAssessment = {
  'A-001': [
    { id:'F-1', name:'Finalized Evidence', created:'May 1, 2020 15:00:00 AM', modified:'May 14, 2019 15:00:00 AM', size:'1 Item' },
    { id:'F-2', name:'Evidence1 Version 1.doc', created:'Nov 13, 2020 12:01:05 AM', modified:'Nov 13, 2020 12:01:05 AM', size:'10 MB' },
  ]
};

// Section attachments mapping: { [assessmentId]: { [subsectionId]: [attachmentId] } }
const sectionAttachmentsByAssessment = {
  // example: 'A-002': { '1.1': ['F-abc'] }
};

// Answers store: { [assessmentId]: { [subsectionId]: { fieldId: value } } }
const answersByAssessment = {
  'A-002': {
    '1.1': { companyName: 'ABC Inc.', companyAddress: '320, Petro Avenue Ln', assessorCompany: 'ABC Inc.' }
  }
};

// Framework structures (minimal demo). Keyed by the value stored in assessment.framework
// For production, prefer stable framework codes (e.g., pci-dss-4-0) and a dedicated /frameworks API.
const frameworkStructures = {
  'PCI DSS 4.0': {
    code: 'pci-dss-4-0',
    parts: [
      {
        title: 'Part I: Assessment Overview',
        sections: [
          {
            number: 1,
            heading: 'Contact Information and Summary of Results',
            items: [
              { id: '1.1', number: '1.1', label: 'Contact Information', fields: [
                // Assessed Entity
                { id:'ae_heading', type:'heading', label:'Assessed Entity' },
                { id:'companyName', type:'text', label:'Company name', required:true },
                { id:'dba', type:'text', label:'DBA (doing business as)' },
                { id:'mailingAddress', type:'text', label:'Mailing address' },
                { id:'companyWebsite', type:'text', label:'Company main website' },
                { id:'contactName', type:'text', label:'Contact name' },
                { id:'contactTitle', type:'text', label:'Contact title' },
                { id:'contactPhone', type:'text', label:'Contact phone number' },
                { id:'contactEmail', type:'text', label:'Contact e-mail address' },
                { id:'div1', type:'divider', label:'' },
                // Assessed Entity Internal Security Assessors
                { id:'isa_heading', type:'heading', label:'Assessed Entity Internal Security Assessors' },
                { id:'isaName', type:'text', label:'ISA name' },
                { id:'div2', type:'divider', label:'' },
                // Qualified Security Assessor Company
                { id:'qsa_heading', type:'heading', label:'Qualified Security Assessor Company' },
                { id:'assessorCompany', type:'text', label:'Company name' },
                { id:'assessorMailingAddress', type:'text', label:'Mailing address' },
                { id:'assessorWebsite', type:'text', label:'Company website' },
                { id:'div3', type:'divider', label:'' },
                // Lead Qualified Security Assessor
                { id:'lead_heading', type:'heading', label:'Lead Qualified Security Assessor' },
                { id:'leadAssessorName', type:'text', label:'Lead Assessor name' },
                { id:'leadAssessorPhone', type:'text', label:'Assessor phone number' },
                { id:'leadAssessorEmail', type:'text', label:'Assessor e-mail address' },
                { id:'leadAssessorCert', type:'text', label:'Assessor certificate number' },
                { id:'div4', type:'divider', label:'' },
                // Additional Assessors
                { id:'add_heading', type:'heading', label:'Additional Assessors' },
                { id:'associateQsaName', type:'text', label:'Associate QSA name' },
                { id:'associateQsaMentorName', type:'text', label:'Associate QSA mentor name' },
                { id:'assessorName', type:'text', label:'Assessor name' },
                { id:'assessorCertificate', type:'text', label:'Assessor certificate number' },
                { id:'div5', type:'divider', label:'' },
                // QA Primary Reviewer
                { id:'qa_heading', type:'heading', label:'Assessor Quality Assurance (QA) Primary Reviewer for this specific report' },
                { id:'qaReviewerName', type:'text', label:'QA reviewer name' },
                { id:'qaReviewerPhone', type:'text', label:'QA reviewer phone number' },
                { id:'qaReviewerEmail', type:'text', label:'QA reviewer e-mail address' },
                { id:'qaReviewerCredentials', type:'text', label:'QA reviewer’s PCI credentials or certificate number' },
                { id:'div6', type:'divider', label:'' },
                { id:'notes', type:'textarea', label:'Notes' }
              ] },
              { id: '1.2', number: '1.2', label: 'Date and Timeframe of Assessment',
                description: 'Provide the dates related to the ROC and the assessment timeframe.',
                fields: [
                  { id:'dateOfReport', type:'date', label:'Date of Report', help: 'Date of Report: The “Date of Report” indicates the completion date of the ROC, and therefore must be no earlier than the date on which the QSA Company and assessed entity agree on the final version of the ROC.' },
                  { id:'dateAssessmentBegan', type:'date', label:'Date assessment began', help: 'This is the first date that evidence was gathered, or observations were made.' },
                  { id:'dateAssessmentEnded', type:'date', label:'Date assessment ended', help: 'This is the last date that evidence was gathered, or observations were made.' },
                  { id:'onsiteDates', type:'text', label:"Identify the date(s) spent onsite at the assessed entity." }
                ]
              },
              { id: '1.3', number: '1.3', label: 'Remote Assessment Activities',
                description: 'Refer to the PCI SSC Remote Assessment Guidelines and Procedures on the PCI SSC website for more information.',
                fields: [
                  { id:'remoteTestingExtent', type:'radio', label:'To what extent were remote testing methods used for this assessment?', options:[
                    'All testing was performed onsite',
                    'A combination of onsite and remote testing methods was used',
                    'All testing was performed remotely'
                  ]},
                  { id:'remoteTestingReason', type:'textarea', label:'If remote testing was used, briefly describe why onsite testing was not feasible or practical.' }
                ]
              },
              { id: '1.4', number: '1.4', label: 'Additional Services Provided by QSA Company',
                description: 'Complete after reviewing the relevant portions of the QSA Qualification Requirements to ensure responses are consistent with documented obligations.',
                fields: [
                  { id:'consultationProvided', type:'radio', label:'Indicate whether the QSA Company provided any consultation on the development or implementation of controls used for the Customized Approach. (Does not apply to the assessment of the Customized Approach.)', options:['Yes','No'] },
                  { id:'consultationDescription', type:'textarea', label:'If “Yes,” describe the nature of the consultation.' },
                  { id:'discloseProductsServices', type:'textarea', label:'Disclose all products or services provided to the assessed entity by the QSA Company that could reasonably be viewed to affect independence of assessment.' },
                  { id:'conflictMitigation', type:'textarea', label:'Describe efforts made to ensure no conflict of interest resulted from the above-mentioned products and services.' }
                ]
              },
              { id: '1.5', number: '1.5', label: 'Use of Subcontractors',
  description: 'Indicate whether any assessment activities were subcontracted to another Assessor Company.',
  fields: [
    { id:'subcontracted', type:'radio', label:'Indicate whether any assessment activities were subcontracted to another Assessor Company.', options:['Yes','No'] },
    { id:'subcontractors', type:'textarea', label:'If yes, identify the Assessor Company(s) utilized during the assessment.' }
  ]
},
{ id: '1.6', number: '1.6', label: 'Additional Information/Reporting',
  description: 'Identify the number of consecutive years (including the current year) the QSA Company has issued ROCs for this entity.',
  fields: [
    { id:'consecutiveYearsRocs', type:'number', label:'Number of consecutive years QSA has issued ROCs for this entity' }
  ]
},
{ id: '1.7', number: '1.7', label: 'Overall Assessment Result',
  description: 'Select whether a full or partial assessment was completed, then select one overall result.',
  fields: [
    { id:'assessmentCompletion', type:'radio-table', label:'Indicate below whether a full or partial assessment was completed. Select only one.', options:[
      'Full Assessment | All requirements have been assessed and therefore no requirements were marked as Not Tested.',
      'Partial Assessment | One or more requirements have not been assessed and were therefore marked as Not Tested. Any requirement not assessed is noted as Not Tested in section 1.8.1 below.'
    ] },
    { id:'assessmentOutcome', type:'radio-table', label:'Overall Assessment Result (Select only one)', options:[
      'Compliant | All sections of the PCI DSS ROC are complete, and all assessed requirements are marked as being either In Place or Not Applicable, resulting in an overall COMPLIANT rating; thereby the assessed entity has demonstrated compliance with all PCI DSS requirements except those noted as Not Tested above.',
      'Non-Compliant | Not all sections of the PCI DSS ROC are complete, or one or more requirements are marked as Not in Place, resulting in an overall NON-COMPLIANT rating; thereby the assessed entity has not demonstrated compliance with PCI DSS requirements.',
      'Compliant but with Legal Exception | One or more assessed requirements in the ROC are marked as Not in Place due to a legal restriction that prevents the requirement from being met and all other assessed requirements are marked as being either In Place or Not Applicable, resulting in an overall COMPLIANT BUT WITH LEGAL EXCEPTION rating, thereby the assessed entity has demonstrated compliance with all PCI DSS requirements except those noted as Not Tested above or as Not in Place due to a legal restriction.'
    ] }
  ]
},
              { id: '1.8', number: '1.8', label: 'Summary of Assessment',
                description: 'Summary of Assessment Findings and Methods',
                fields: [
                  { id:'summaryPrincipal', type:'checkbox-table', label:'Assessment Finding — Select all options that apply.',
                    columns:[
                      { id:'inPlace', label:'In Place', group:'Assessment Finding' },
                      { id:'notApplicable', label:'Not Applicable', group:'Assessment Finding' },
                      { id:'notTested', label:'Not Tested', group:'Assessment Finding' },
                      { id:'notInPlace', label:'Not in Place', group:'Assessment Finding' },
                      { id:'compensatingControl', label:'Compensating Control', group:'Select If Below Method(s) Was Used' },
                      { id:'customizedApproach', label:'Customized Approach', group:'Select If Below Method(s) Was Used' }
                    ],
                    rows:[
                      { id:'r1', label:'Requirement 1:' },
                      { id:'r2', label:'Requirement 2:' },
                      { id:'r3', label:'Requirement 3:' },
                      { id:'r4', label:'Requirement 4:' },
                      { id:'r5', label:'Requirement 5:' },
                      { id:'r6', label:'Requirement 6:' },
                      { id:'r7', label:'Requirement 7:' },
                      { id:'r8', label:'Requirement 8:' },
                      { id:'r9', label:'Requirement 9:' },
                      { id:'r10', label:'Requirement 10:' },
                      { id:'r11', label:'Requirement 11:' },
                      { id:'r12', label:'Requirement 12:' }
                    ]
                  },
                  { id:'summaryAppendix', type:'checkbox-table', label:'Assessment Finding — Select all options that apply.',
                    columns:[
                      { id:'inPlace', label:'In Place', group:'Assessment Finding' },
                      { id:'notApplicable', label:'Not Applicable', group:'Assessment Finding' },
                      { id:'notTested', label:'Not Tested', group:'Assessment Finding' },
                      { id:'notInPlace', label:'Not in Place', group:'Assessment Finding' },
                      { id:'compensatingControl', label:'Compensating Control', group:'Select If Below Method(s) Was Used' },
                      { id:'customizedApproach', label:'Customized Approach', group:'Select If Below Method(s) Was Used' }
                    ],
                    rows:[
                      { id:'a1', label:'Appendix A1:' },
                      { id:'a2', label:'Appendix A2:' },
                      { id:'a3', label:'Appendix A3:' }
                    ]
                  }
                ]
              },
],
          },          {
            number: 2,
            heading: 'Business Overview',
            items: [
              { id: '2.1', number: '2.1', label: 'Description of the Entity’s Payment Card Business',
                fields: [
                  { id:'businessOverview', type:'form-table', label:'', help:'Provide an overview of the entity’s payment card business, including:', rows: [
                    { id:'descNature', type:'textarea', label:'Describe the nature of the entity’s business (what kind of work they do, etc.).', help:'Note: This is not intended to be a cut-and-paste from the entity’s website but should be a tailored description that shows the assessor understands the business of the entity being assessed.' },
                    { id:'descStoreProcess', type:'textarea', label:'Describe the entity’s business, services, or functions that store, process, or transmit account data.' },
                    { id:'descImpactSecurity', type:'textarea', label:'Describe any services or functions that the entity performs that could impact the security of account data. (For example, merchant web site payment redirects or if the entity provides managed services)' },
                    { id:'paymentChannels', type:'checkboxes', label:'Identify the payment channels the entity utilizes.', options:['Card-Present','Mail Order/Telephone Order (MOTO)','E-Commerce'] },
                    { id:'otherDetails', type:'textarea', label:'Other details, if applicable:' }
                  ] }
                ]
              },
            ],
          },
{
